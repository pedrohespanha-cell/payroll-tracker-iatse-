<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payroll Tracker V2</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Space+Mono:wght@400;700&display=swap');
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --bg: #0a0e27;
      --surface: #151932;
      --surface-hover: #1d2342;
      --border: #2a3254;
      --text: #e4e7f5;
      --text-dim: #8a91b8;
      --accent: #00d9ff;
      --accent-glow: rgba(0, 217, 255, 0.3);
      --success: #00ff9d;
      --warning: #ffb800;
      --error: #ff4757;
    }
    
    body {
      font-family: 'DM Mono', monospace;
      background: var(--bg);
      color: var(--text);
      padding: 0;
      margin: 0;
      min-height: 100vh;
      background-image: 
        radial-gradient(circle at 20% 50%, rgba(0, 217, 255, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(0, 255, 157, 0.05) 0%, transparent 50%);
    }
    
    .container {
      max-width: 100%;
      padding: 16px;
    }
    
    header {
      padding: 24px 0 16px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 24px;
    }
    
    h1 {
      font-family: 'Space Mono', monospace;
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.5px;
      margin-bottom: 4px;
      background: linear-gradient(135deg, var(--accent), var(--success));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .subtitle {
      font-size: 12px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    /* Entry Form */
    .entry-form {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.3);
    }
    
    .form-title {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 16px;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    label {
      display: block;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-dim);
      margin-bottom: 6px;
    }
    
    input, select {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 14px;
      transition: all 0.2s;
    }
    
    input:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }
    
    input::placeholder {
      color: var(--text-dim);
      opacity: 0.5;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    
    input[type="date"],
    input[type="time"],
    input[type="number"],
    input[type="text"],
    textarea,
    select {
      max-width: 100%;
      box-sizing: border-box;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      margin-top: 8px;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: auto;
      margin-right: 8px;
    }
    
    .checkbox-group label {
      margin-bottom: 0;
      text-transform: none;
      font-size: 13px;
      color: var(--text);
    }
    
    button {
      width: 100%;
      background: linear-gradient(135deg, var(--accent), var(--success));
      border: none;
      border-radius: 8px;
      padding: 14px;
      color: var(--bg);
      font-family: 'Space Mono', monospace;
      font-size: 14px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      cursor: pointer;
      transition: all 0.3s;
      margin-top: 8px;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px var(--accent-glow);
    }
    
    button:active {
      transform: translateY(0);
    }
    
    /* Weekly Summary */
    .weekly-summary {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
    }
    
    .week-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    
    .week-title {
      font-family: 'Space Mono', monospace;
      font-size: 16px;
      font-weight: 700;
      color: var(--accent);
    }
    
    .week-range {
      font-size: 11px;
      color: var(--text-dim);
    }
    
    .summary-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    .summary-item {
      background: var(--bg);
      border-radius: 8px;
      padding: 12px;
    }
    
    .summary-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-dim);
      margin-bottom: 6px;
    }
    
    .summary-value {
      font-family: 'Space Mono', monospace;
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
    }
    
    .summary-value.money {
      color: var(--success);
    }
    
    .summary-value.hours {
      color: var(--accent);
    }
    
    /* Entries List */
    .entries-section {
      margin-bottom: 24px;
    }
    
    .section-title {
      font-family: 'Space Mono', monospace;
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 12px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .entry-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s;
      position: relative;
    }
    
    .entry-card:hover {
      border-color: var(--accent);
      background: var(--surface-hover);
    }
    
    .entry-card.grouped {
      border-left: 3px solid var(--warning);
    }
    
    .entry-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    
    .entry-date {
      font-family: 'Space Mono', monospace;
      font-size: 14px;
      font-weight: 700;
      color: var(--accent);
    }
    
    .entry-show {
      font-size: 18px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }
    
    .entry-time {
      font-size: 14px;
      color: var(--text-dim);
    }
    
    .entry-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }
    
    .detail-item {
      display: flex;
      flex-direction: column;
    }
    
    .detail-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-dim);
      margin-bottom: 4px;
    }
    
    .detail-value {
      font-family: 'Space Mono', monospace;
      font-size: 14px;
      font-weight: 700;
      color: var(--text);
    }
    
    .detail-value.money {
      color: var(--success);
    }
    
    .detail-value.rate {
      color: var(--accent);
    }
    
    .entry-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }
    
    .btn-delete {
      flex: 1;
      background: var(--error);
      padding: 8px;
      font-size: 11px;
    }
    
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-dim);
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.3;
    }
    
    @media (max-width: 480px) {
      .summary-grid {
        grid-template-columns: 1fr;
      }
      
      .entry-details {
        grid-template-columns: 1fr;
      }
    }
    
    /* Loading animation */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .loading {
      animation: pulse 1.5s ease-in-out infinite;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <h1>Payroll Tracker <span style="font-size: 14px; color: var(--accent); font-weight: 600;">V2</span></h1>
          <div class="subtitle">Track hours & earnings ‚Ä¢ Customizable UI</div>
        </div>
        <div style="display: flex; gap: 8px; position: relative;">
          <button onclick="toggleCustomizeMode()" style="padding: 8px 12px; font-size: 11px; background: var(--accent); width: auto; margin: 0;">
            üé® Customize
          </button>
          <button onclick="toggleBackupMenu()" style="padding: 8px 12px; font-size: 11px; background: var(--border); width: auto; margin: 0;">
            ‚öôÔ∏è Data
          </button>
          <div id="backupMenu" style="display: none; position: absolute; right: 0; top: 100%; margin-top: 8px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 12px; min-width: 240px; max-width: 320px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
            <div style="font-size: 10px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">
              Data Management
            </div>
            <button onclick="quickSaveToCloud(); toggleBackupMenu();" style="width: 100%; padding: 8px; font-size: 11px; background: var(--success); margin-bottom: 4px;">
              üíæ Save CSV Backup
            </button>
            <label style="position: relative; display: block; margin-bottom: 4px;">
              <button style="width: 100%; padding: 8px; font-size: 11px; background: var(--accent);">
                üì• Load CSV
              </button>
              <input type="file" accept=".csv" onchange="quickLoadFromCloud(event); toggleBackupMenu();" style="position: absolute; opacity: 0; width: 100%; height: 100%; top: 0; left: 0; cursor: pointer;">
            </label>
            <button onclick="restoreBackup(); toggleBackupMenu();" style="width: 100%; padding: 8px; font-size: 11px; background: var(--error); margin-bottom: 12px;">
              ‚Ü∂ Undo Last Import
            </button>
            
            <div id="csvTrackingInfo" style="border-top: 1px solid var(--border); padding-top: 8px; margin-top: 8px; font-size: 9px; color: var(--text-dim); line-height: 1.4;">
              <!-- Tracking info will be inserted here -->
            </div>
            
            <div style="font-size: 8px; color: var(--text-dim); margin-top: 8px; padding: 6px; background: var(--bg); border-radius: 4px; line-height: 1.3;">
              üí° Backups are timestamped for easy tracking
            </div>
          </div>
        </div>
      </div>
    </header>
    
    <!-- Customization Modal -->
    <div id="customizeModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; overflow-y: auto;">
      <div style="max-width: 800px; margin: 40px auto; background: var(--bg); border-radius: 12px; padding: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <h2 style="margin: 0; font-size: 24px;">Customize Layout</h2>
          <button onclick="toggleCustomizeMode()" style="background: transparent; border: none; color: var(--text); font-size: 24px; cursor: pointer; padding: 0; width: auto; margin: 0;">√ó</button>
        </div>
        
        <div style="margin-bottom: 24px; padding: 16px; background: var(--surface); border-radius: 8px;">
          <p style="margin: 0 0 8px 0; font-size: 14px; line-height: 1.6; color: var(--success);">
            <strong>‚úÖ Fully Functional!</strong> Drag fields to reorder, toggle on/off, and your changes apply immediately.
          </p>
          <p style="margin: 0; font-size: 12px; line-height: 1.6; color: var(--text-dim);">
            üí° <strong>Tip:</strong> Disable fields you don't need to declutter your view. Drag the ‚ãÆ‚ãÆ handles to reorder. Click "Save Layout" to persist your preferences.
          </p>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px;">
          <!-- This Week Stats -->
          <div>
            <h3 style="font-size: 16px; margin-bottom: 12px; color: var(--accent);">üìä This Week Stats</h3>
            <div id="thisWeekStatsCustomize"></div>
          </div>
          
          <!-- Week Headers -->
          <div>
            <h3 style="font-size: 16px; margin-bottom: 12px; color: var(--accent);">üìÖ Week Headers</h3>
            <div id="weekHeaderCustomize"></div>
          </div>
          
          <!-- All Time Stats -->
          <div>
            <h3 style="font-size: 16px; margin-bottom: 12px; color: var(--accent);">üìà All Time Stats</h3>
            <div id="allTimeStatsCustomize"></div>
          </div>
        </div>
        
        <div style="margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--border); display: flex; gap: 12px; justify-content: flex-end;">
          <button onclick="resetCustomization()" style="background: var(--border); width: auto; padding: 12px 24px;">
            Reset to Defaults
          </button>
          <button onclick="saveCustomization()" style="background: var(--success); width: auto; padding: 12px 24px;">
            Save Layout
          </button>
        </div>
      </div>
    </div>
    
    <!-- Entry Form -->
    <div class="entry-form">
      <div class="form-title">New Entry</div>
      
      <div class="form-group">
        <label>Date</label>
        <input type="date" id="date" required>
      </div>
      
      <div class="form-group">
        <label>Show Name</label>
        <input type="text" id="show" placeholder="e.g. Dreamland">
      </div>
      
      <div class="form-group">
        <label>Position Type</label>
        <select id="positionType" onchange="handlePositionTypeChange()">
          <option value="Rigging LX">Rigging LX</option>
          <option value="Shooting LX">Shooting LX</option>
          <option value="Genny">Genny</option>
          <option value="Wireperson">Wireperson</option>
          <option value="Other">Other (specify)</option>
        </select>
        <input type="text" id="positionTypeOther" placeholder="Specify position" style="display: none; margin-top: 8px;">
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Start Time</label>
          <input type="time" id="startTime" required>
        </div>
        <div class="form-group">
          <label>End Time</label>
          <input type="time" id="endTime" required>
        </div>
      </div>
      
      <div class="form-group">
        <label>Notes</label>
        <input type="text" id="notes" placeholder="Optional notes">
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label>Gross Pay ($)</label>
          <input type="number" id="grossPay" step="0.01" placeholder="0.00">
        </div>
        <div class="form-group">
          <label>Net Pay ($)</label>
          <input type="number" id="netPay" step="0.01" placeholder="0.00">
        </div>
      </div>
      
      <div class="form-group">
        <label>Minimum Pay Type (Optional)</label>
        <select id="minPayType">
          <option value="">None</option>
          <option value="8hr">8 Hour Minimum (Standard)</option>
          <option value="10hr">10 Hour Minimum (8hr + 2hr @ 1.5x)</option>
          <option value="12hr">12 Hour Minimum (8hr + 4hr @ 1.5x)</option>
        </select>
        <div style="display: flex; align-items: center; margin-top: 8px; font-size: 12px;">
          <input type="checkbox" id="setAsDefault" style="width: auto; margin-right: 6px;">
          <label for="setAsDefault" style="margin: 0; cursor: pointer;">Set as default for this show + position</label>
        </div>
      </div>
      
      <button onclick="addEntry()">Add Entry</button>
      <button id="cancelBtn" onclick="clearForm()" style="display: none; background: var(--border); margin-top: 8px;">Cancel Edit</button>
    </div>
    
    <!-- CSV Sync Guide -->
    <div id="icloudGuide" style="background: linear-gradient(135deg, var(--surface), var(--bg)); border: 1px solid var(--accent); border-radius: 12px; padding: 16px; margin-bottom: 24px;">
      <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
        <div style="font-size: 14px; font-weight: 700; color: var(--accent);">
          üíæ CSV Sync Setup
        </div>
        <button onclick="document.getElementById('icloudGuide').style.display='none'" style="background: transparent; border: none; color: var(--text-dim); padding: 0; font-size: 18px; cursor: pointer; width: auto; margin: 0;">√ó</button>
      </div>
      <div style="font-size: 12px; line-height: 1.6; color: var(--text);">
        <strong>First time:</strong>
        <ol style="margin: 8px 0; padding-left: 20px;">
          <li>Add some entries</li>
          <li>Tap "‚öôÔ∏è Data" ‚Üí "üíæ Save CSV"</li>
          <li>File downloads as <code>payroll-data.csv</code></li>
        </ol>
        <strong>To sync:</strong>
        <ol style="margin: 8px 0; padding-left: 20px;">
          <li>Tap "‚öôÔ∏è Data" ‚Üí "üì• Load CSV"</li>
          <li>Select your payroll-data.csv file</li>
          <li>Done! Your data is synced</li>
        </ol>
        <div style="font-size: 10px; color: var(--text-dim); margin-top: 8px; padding: 8px; background: var(--bg); border-radius: 4px;">
          üí° Pro tip: Save your CSV to iCloud Drive or Google Drive for backup!
        </div>
      </div>
    </div>
    
    <!-- Weekly Summary -->
    <div id="weeklySummary"></div>
    
    <!-- Global Stats -->
    <div id="globalStats"></div>
    
    <!-- Entries List -->
    <div class="entries-section">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <div class="section-title">All Entries</div>
        <div style="display: flex; gap: 8px;">
          <button onclick="expandAllWeeks()" style="padding: 6px 12px; font-size: 11px; background: var(--border); width: auto; margin: 0;">
            Expand All
          </button>
          <button onclick="collapseAllWeeks()" style="padding: 6px 12px; font-size: 11px; background: var(--border); width: auto; margin: 0;">
            Collapse All
          </button>
        </div>
      </div>
      <div id="entriesList"></div>
    </div>
  </div>
  
  <script>
    // Initialize
    let entries = [];
    let editingId = null;
    let customPositions = []; // Store custom "Other" positions
    let positionDefaults = {}; // Store default min pay per show+position
    
    // V2: Customization Configuration
    const DEFAULT_THISWEEK_FIELDS = [
      { id: 'hoursWorked', label: 'Hours Worked', enabled: true },
      { id: 'standardPayable', label: 'Standard Payable Hrs', enabled: true },
      { id: 'daysWorked', label: 'Days Worked', enabled: true },
      { id: 'numShows', label: 'Number of Shows', enabled: true },
      { id: 'standard1x', label: 'Standard (1x)', enabled: true },
      { id: 'ot15x', label: 'OT (1.5x)', enabled: true },
      { id: 'time2x', label: '2x Time', enabled: true },
      { id: 'time3x', label: '3x Time', enabled: true },
      { id: 'avgGrossHr', label: 'Avg Gross/Hr', enabled: true },
      { id: 'avgNetHr', label: 'Avg Net/Hr', enabled: true }
    ];
    
    const DEFAULT_WEEKHEADER_FIELDS = [
      { id: 'weekNumber', label: 'Week Number (X of 52)', enabled: true },
      { id: 'dateRange', label: 'Date Range', enabled: true },
      { id: 'daysShows', label: 'Days/Shows Count', enabled: true },
      { id: 'totalHours', label: 'Total Hours', enabled: true },
      { id: 'grossPay', label: 'Gross Pay', enabled: true },
      { id: 'netPay', label: 'Net Pay', enabled: true },
      { id: 'pendingCheques', label: 'Pending Cheques', enabled: true }
    ];
    
    const DEFAULT_ALLTIME_FIELDS = [
      { id: 'totalHours', label: 'Total Hours', enabled: true },
      { id: 'totalDays', label: 'Total Days', enabled: true },
      { id: 'totalStandard', label: 'Total Standard (1x)', enabled: true },
      { id: 'totalGrossPay', label: 'Total Gross Pay', enabled: true },
      { id: 'totalNetPay', label: 'Total Net Pay', enabled: true },
      { id: 'avgGrossHr', label: 'Avg Gross/Hr', enabled: true },
      { id: 'avgNetHr', label: 'Avg Net/Hr', enabled: true },
      { id: 'pendingShows', label: 'Pay Pending Shows', enabled: true },
      { id: 'pendingDays', label: 'Pay Pending Days', enabled: true },
      { id: 'pendingHours', label: 'Pay Pending Hours', enabled: true }
    ];
    
    let thisWeekFieldsConfig = [...DEFAULT_THISWEEK_FIELDS];
    let weekHeaderFieldsConfig = [...DEFAULT_WEEKHEADER_FIELDS];
    let allTimeFieldsConfig = [...DEFAULT_ALLTIME_FIELDS];
    
    // V2: Toggle customize mode
    function toggleCustomizeMode() {
      const modal = document.getElementById('customizeModal');
      if (modal.style.display === 'none') {
        modal.style.display = 'block';
        renderCustomizationUI();
      } else {
        modal.style.display = 'none';
      }
    }
    
    // V2: Render customization UI
    function renderCustomizationUI() {
      // Helper function to render a customization section
      const renderSection = (config, containerId, sectionType) => {
        const container = document.getElementById(containerId);
        container.innerHTML = config.map((field, index) => `
          <div draggable="true" 
               ondragstart="dragStart(event, '${sectionType}', ${index})" 
               ondragover="allowDrop(event)" 
               ondrop="drop(event, '${sectionType}', ${index})"
               style="background: var(--surface); padding: 12px; margin-bottom: 8px; border-radius: 6px; cursor: move; display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border);">
            <div style="display: flex; align-items: center; gap: 8px;">
              <span style="color: var(--text-dim);">‚ãÆ‚ãÆ</span>
              <span style="font-size: 11px;">${field.label}</span>
            </div>
            <label style="display: flex; align-items: center; gap: 8px; margin: 0; cursor: pointer;">
              <input type="checkbox" 
                     ${field.enabled ? 'checked' : ''} 
                     onchange="toggleField('${sectionType}', ${index})"
                     style="width: auto; margin: 0; cursor: pointer;">
              <span style="font-size: 10px; color: var(--text-dim);">${field.enabled ? 'On' : 'Off'}</span>
            </label>
          </div>
        `).join('');
      };
      
      // Render all three sections
      renderSection(thisWeekFieldsConfig, 'thisWeekStatsCustomize', 'thisweek');
      renderSection(weekHeaderFieldsConfig, 'weekHeaderCustomize', 'weekheader');
      renderSection(allTimeFieldsConfig, 'allTimeStatsCustomize', 'alltime');
    }
    
    // V2: Drag and drop
    let draggedItem = null;
    let draggedType = null;
    let draggedIndex = null;
    
    function dragStart(event, type, index) {
      draggedType = type;
      draggedIndex = index;
      event.dataTransfer.effectAllowed = 'move';
    }
    
    function allowDrop(event) {
      event.preventDefault();
    }
    
    function drop(event, type, dropIndex) {
      event.preventDefault();
      if (draggedType !== type) return;
      if (draggedIndex === dropIndex) return;
      
      let config;
      if (type === 'thisweek') {
        config = thisWeekFieldsConfig;
      } else if (type === 'weekheader') {
        config = weekHeaderFieldsConfig;
      } else {
        config = allTimeFieldsConfig;
      }
      
      const [removed] = config.splice(draggedIndex, 1);
      config.splice(dropIndex, 0, removed);
      
      if (type === 'thisweek') {
        thisWeekFieldsConfig = config;
      } else if (type === 'weekheader') {
        weekHeaderFieldsConfig = config;
      } else {
        allTimeFieldsConfig = config;
      }
      
      renderCustomizationUI();
    }
    
    // V2: Toggle field enabled/disabled
    function toggleField(type, index) {
      if (type === 'thisweek') {
        thisWeekFieldsConfig[index].enabled = !thisWeekFieldsConfig[index].enabled;
      } else if (type === 'weekheader') {
        weekHeaderFieldsConfig[index].enabled = !weekHeaderFieldsConfig[index].enabled;
      } else {
        allTimeFieldsConfig[index].enabled = !allTimeFieldsConfig[index].enabled;
      }
      renderCustomizationUI();
    }
    
    // V2: Save customization
    function saveCustomization() {
      localStorage.setItem('payroll-thisweek-fields', JSON.stringify(thisWeekFieldsConfig));
      localStorage.setItem('payroll-weekheader-fields', JSON.stringify(weekHeaderFieldsConfig));
      localStorage.setItem('payroll-alltime-fields', JSON.stringify(allTimeFieldsConfig));
      toggleCustomizeMode();
      renderAll();
      alert('Layout saved! Your preferences have been applied.');
    }
    
    // V2: Reset customization
    function resetCustomization() {
      if (confirm('Reset to default layout? This will restore all fields to their original order and visibility.')) {
        thisWeekFieldsConfig = [...DEFAULT_THISWEEK_FIELDS];
        weekHeaderFieldsConfig = [...DEFAULT_WEEKHEADER_FIELDS];
        allTimeFieldsConfig = [...DEFAULT_ALLTIME_FIELDS];
        localStorage.removeItem('payroll-thisweek-fields');
        localStorage.removeItem('payroll-weekheader-fields');
        localStorage.removeItem('payroll-alltime-fields');
        renderCustomizationUI();
        renderAll();
        alert('Layout reset to defaults!');
      }
    }
    
    // V2: Load customization on startup
    function loadCustomization() {
      const savedThisWeek = localStorage.getItem('payroll-thisweek-fields');
      const savedWeekHeader = localStorage.getItem('payroll-weekheader-fields');
      const savedAllTime = localStorage.getItem('payroll-alltime-fields');
      
      if (savedThisWeek) {
        try {
          thisWeekFieldsConfig = JSON.parse(savedThisWeek);
        } catch (e) {
          console.error('Error loading this week config:', e);
        }
      }
      
      if (savedWeekHeader) {
        try {
          weekHeaderFieldsConfig = JSON.parse(savedWeekHeader);
        } catch (e) {
          console.error('Error loading week header config:', e);
        }
      }
      
      if (savedAllTime) {
        try {
          allTimeFieldsConfig = JSON.parse(savedAllTime);
        } catch (e) {
          console.error('Error loading alltime config:', e);
        }
      }
    }
    
    // V2: Helper functions to check if fields are enabled
    function isThisWeekFieldEnabled(fieldId) {
      const field = thisWeekFieldsConfig.find(f => f.id === fieldId);
      return field ? field.enabled : true;
    }
    
    function isWeekHeaderFieldEnabled(fieldId) {
      const field = weekHeaderFieldsConfig.find(f => f.id === fieldId);
      return field ? field.enabled : true;
    }
    
    function isAllTimeFieldEnabled(fieldId) {
      const field = allTimeFieldsConfig.find(f => f.id === fieldId);
      return field ? field.enabled : true;
    }
    
    // V2: Get field order for rendering (only enabled fields)
    function getThisWeekFieldOrder() {
      return thisWeekFieldsConfig.filter(f => f.enabled).map(f => f.id);
    }
    
    function getWeekHeaderFieldOrder() {
      return weekHeaderFieldsConfig.filter(f => f.enabled).map(f => f.id);
    }
    
    function getAllTimeFieldOrder() {
      return allTimeFieldsConfig.filter(f => f.enabled).map(f => f.id);
    }
    
    // Handle position type change
    function handlePositionTypeChange() {
      const select = document.getElementById('positionType');
      const otherInput = document.getElementById('positionTypeOther');
      
      if (select.value === 'Other') {
        otherInput.style.display = 'block';
        otherInput.required = true;
      } else {
        otherInput.style.display = 'none';
        otherInput.required = false;
        otherInput.value = '';
      }
      
      // Load default min pay for this show+position combo
      loadPositionDefaults();
    }
    
    // Load default min pay for current show+position
    function loadPositionDefaults() {
      const show = document.getElementById('show').value.trim();
      const positionType = getPositionType();
      
      if (!show || !positionType) return;
      
      const key = `${show}::${positionType}`;
      if (positionDefaults[key]) {
        document.getElementById('minPayType').value = positionDefaults[key];
      }
    }
    
    // Get current position type (handles "Other" case)
    function getPositionType() {
      const select = document.getElementById('positionType');
      if (select.value === 'Other') {
        const otherValue = document.getElementById('positionTypeOther').value.trim();
        return otherValue || 'Other';
      }
      return select.value;
    }
    
    // Save position default if checkbox is checked
    function savePositionDefault() {
      const setAsDefault = document.getElementById('setAsDefault').checked;
      if (!setAsDefault) return;
      
      const show = document.getElementById('show').value.trim();
      const positionType = getPositionType();
      const minPayType = document.getElementById('minPayType').value;
      
      if (!show || !positionType) return;
      
      const key = `${show}::${positionType}`;
      positionDefaults[key] = minPayType;
      localStorage.setItem('payroll-position-defaults', JSON.stringify(positionDefaults));
    }
    
    // Add custom position to dropdown if "Other" is used
    function addCustomPosition(positionName) {
      if (!positionName || positionName === 'Other') return;
      if (customPositions.includes(positionName)) return;
      
      customPositions.push(positionName);
      localStorage.setItem('payroll-custom-positions', JSON.stringify(customPositions));
      
      // Add to dropdown
      const select = document.getElementById('positionType');
      const option = document.createElement('option');
      option.value = positionName;
      option.textContent = positionName;
      select.insertBefore(option, select.querySelector('option[value="Other"]'));
    }
    
    // Load data on startup
    function loadData() {
      try {
        const saved = localStorage.getItem('payroll-entries');
        if (saved) {
          entries = JSON.parse(saved);
          
          // Migrate old entries without positionType
          entries = entries.map(entry => ({
            ...entry,
            positionType: entry.positionType || 'Rigging LX'
          }));
          
          renderAll();
        }
        
        // Load custom positions
        const savedPositions = localStorage.getItem('payroll-custom-positions');
        if (savedPositions) {
          customPositions = JSON.parse(savedPositions);
          // Add them to dropdown
          const select = document.getElementById('positionType');
          customPositions.forEach(pos => {
            const option = document.createElement('option');
            option.value = pos;
            option.textContent = pos;
            select.insertBefore(option, select.querySelector('option[value="Other"]'));
          });
        }
        
        // Load position defaults
        const savedDefaults = localStorage.getItem('payroll-position-defaults');
        if (savedDefaults) {
          positionDefaults = JSON.parse(savedDefaults);
        }
        
        // V2: Load customization preferences
        loadCustomization();
        
        // Set today's date as default
        setTodayDate();
      } catch (error) {
        console.log('No existing data found, starting fresh');
        setTodayDate();
        renderAll();
      }
    }
    
    // Set today's date in the date field
    function setTodayDate() {
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      document.getElementById('date').value = `${year}-${month}-${day}`;
    }
    
    // Save data
    function saveData() {
      try {
        localStorage.setItem('payroll-entries', JSON.stringify(entries));
        // Auto-export to CSV backup
        exportToCSV(true);
      } catch (error) {
        console.error('Error saving data:', error);
        alert('Error saving data. Please try again.');
      }
    }
    
    // Export to CSV
    function exportToCSV(autoBackup = false) {
      if (entries.length === 0) {
        if (!autoBackup) alert('No entries to export');
        return;
      }
      
      // CSV header
      let csv = 'Date,Show,Position Type,Start Time,End Time,Notes,Gross Pay,Net Pay,Hours,Min Pay Type\n';
      
      // Add each entry
      entries.forEach(entry => {
        csv += `${entry.date},"${(entry.show || '').replace(/"/g, '""')}","${(entry.positionType || 'Rigging LX').replace(/"/g, '""')}",${entry.startTime},${entry.endTime},"${(entry.notes || '').replace(/"/g, '""')}",${entry.grossPay || ''},${entry.netPay || ''},${entry.hours},${entry.minPayType || ''}\n`;
      });
      
      if (!autoBackup) {
        // Manual download - improved Safari compatibility
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.setAttribute('href', url);
        link.setAttribute('download', `payroll-backup-${new Date().toISOString().split('T')[0]}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      } else {
        // Auto-backup to localStorage
        localStorage.setItem('payroll-csv-backup', csv);
        localStorage.setItem('payroll-last-backup', new Date().toISOString());
      }
    }
    
    // Quick Save to iCloud (downloads with standard name)
    function quickSaveToCloud() {
      if (entries.length === 0) {
        alert('No entries to save');
        return;
      }
      
      // CSV header
      let csv = 'Date,Show,Position Type,Start Time,End Time,Notes,Gross Pay,Net Pay,Hours,Min Pay Type\n';
      
      // Add each entry
      entries.forEach(entry => {
        csv += `${entry.date},"${(entry.show || '').replace(/"/g, '""')}","${(entry.positionType || 'Rigging LX').replace(/"/g, '""')}",${entry.startTime},${entry.endTime},"${(entry.notes || '').replace(/"/g, '""')}",${entry.grossPay || ''},${entry.netPay || ''},${entry.hours},${entry.minPayType || ''}\n`;
      });
      
      // Create structured filename: payroll-2026-02-09-8-entries.csv
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0]; // YYYY-MM-DD
      const entryCount = entries.length;
      const filename = `payroll-${dateStr}-${entryCount}-entries.csv`;
      
      // Create blob and download
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
      
      // Track CSV save info
      const saveInfo = {
        timestamp: new Date().toISOString(),
        entryCount: entries.length
      };
      localStorage.setItem('payroll-last-save', JSON.stringify(saveInfo));
    }
    
    // Quick Load from iCloud
    function quickLoadFromCloud(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const csv = e.target.result;
          const lines = csv.split('\n');
          const newEntries = [];
          
          console.log('CSV Import - Total lines:', lines.length);
          console.log('Header:', lines[0]);
          
          // Skip header row
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            // Split CSV properly, handling quoted fields
            const fields = [];
            let currentField = '';
            let insideQuotes = false;
            
            for (let j = 0; j < line.length; j++) {
              const char = line[j];
              
              if (char === '"') {
                if (insideQuotes && line[j + 1] === '"') {
                  currentField += '"';
                  j++;
                } else {
                  insideQuotes = !insideQuotes;
                }
              } else if (char === ',' && !insideQuotes) {
                fields.push(currentField);
                currentField = '';
              } else {
                currentField += char;
              }
            }
            fields.push(currentField);
            
            console.log(`Line ${i}:`, fields);
            
            // Handle both old format (9 fields) and new format (10 fields with Position Type)
            let date, show, positionType, startTime, endTime, notes, grossPay, netPay, hours, minPayType;
            
            if (fields.length >= 10) {
              // New format with Position Type
              [date, show, positionType, startTime, endTime, notes, grossPay, netPay, hours, minPayType] = fields;
            } else if (fields.length >= 9) {
              // Old format without Position Type
              [date, show, startTime, endTime, notes, grossPay, netPay, hours, minPayType] = fields;
              positionType = 'Rigging LX'; // Default for old entries
              console.log(`Old CSV format detected on line ${i}, defaulting position to Rigging LX`);
            } else {
              console.warn(`Skipping line ${i} - only ${fields.length} fields`);
              continue;
            }
            
            // Clean up the date field
            date = date.trim();
            
            // Validate date format (should be YYYY-MM-DD)
            if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) {
              console.error(`Invalid date format on line ${i}:`, date);
              alert(`Error on line ${i}: Date must be in YYYY-MM-DD format. Found: "${date}"`);
              return;
            }
            
            const entry = {
              id: Date.now() + i,
              date: date,
              show: show.trim(),
              positionType: positionType.trim() || 'Rigging LX',
              startTime: startTime.trim(),
              endTime: endTime.trim(),
              notes: notes.trim(),
              grossPay: grossPay.trim() ? parseFloat(grossPay) : null,
              netPay: netPay.trim() ? parseFloat(netPay) : null,
              hours: parseFloat(hours),
              minPayType: minPayType ? minPayType.trim() : ''
            };
            
            console.log(`Parsed entry ${i}:`, entry);
            newEntries.push(entry);
          }
          
          console.log('Total entries parsed:', newEntries.length);
          
          if (newEntries.length > 0) {
            // Track CSV load info
            const loadInfo = {
              timestamp: new Date().toISOString(),
              entryCount: newEntries.length,
              entries: JSON.stringify(newEntries) // Store snapshot for comparison
            };
            localStorage.setItem('payroll-last-load', JSON.stringify(loadInfo));
            
            entries = newEntries;
            saveData();
            renderAll();
            alert(`‚úÖ Loaded ${newEntries.length} entries from CSV!`);
          } else {
            alert('No entries found in file.');
          }
        } catch (error) {
          console.error('Error loading from iCloud:', error);
          alert('Error loading file: ' + error.message);
        }
      };
      reader.readAsText(file);
      
      event.target.value = '';
    }
    function restoreBackup() {
      try {
        const backup = localStorage.getItem('payroll-backup-before-import');
        if (!backup) {
          alert('No backup found. Backups are only created before importing CSV files.');
          return;
        }
        
        const backupData = JSON.parse(backup);
        const backupDate = new Date(backupData.timestamp).toLocaleString();
        
        if (confirm(`Restore backup from ${backupDate}?\n\nThis will replace your current data with ${backupData.entries.length} entries.`)) {
          entries = backupData.entries;
          saveData();
          renderAll();
          alert('Backup restored successfully!');
        }
      } catch (error) {
        console.error('Error restoring backup:', error);
        alert('Error restoring backup: ' + error.message);
      }
    }
    
    // Import from CSV
    function importFromCSV(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const csv = e.target.result;
          const lines = csv.split('\n');
          const newEntries = [];
          
          console.log('Total lines:', lines.length);
          
          // Skip header row
          for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            console.log('Processing line', i, ':', line);
            
            // Split CSV properly, handling quoted fields
            const fields = [];
            let currentField = '';
            let insideQuotes = false;
            
            for (let j = 0; j < line.length; j++) {
              const char = line[j];
              
              if (char === '"') {
                if (insideQuotes && line[j + 1] === '"') {
                  // Escaped quote
                  currentField += '"';
                  j++; // Skip next quote
                } else {
                  // Toggle quote state
                  insideQuotes = !insideQuotes;
                }
              } else if (char === ',' && !insideQuotes) {
                // End of field
                fields.push(currentField);
                currentField = '';
              } else {
                currentField += char;
              }
            }
            // Add last field
            fields.push(currentField);
            
            console.log('Parsed fields:', fields);
            
            // Handle both old format (9 fields) and new format (10 fields with Position Type)
            let date, show, positionType, startTime, endTime, notes, grossPay, netPay, hours, minPayType;
            
            if (fields.length >= 10) {
              // New format with Position Type
              [date, show, positionType, startTime, endTime, notes, grossPay, netPay, hours, minPayType] = fields;
            } else if (fields.length >= 9) {
              // Old format without Position Type
              [date, show, startTime, endTime, notes, grossPay, netPay, hours, minPayType] = fields;
              positionType = 'Rigging LX'; // Default for old entries
              console.log(`Old CSV format detected on line ${i}, defaulting position to Rigging LX`);
            } else {
              console.log('Skipping line - not enough fields:', fields.length);
              continue;
            }
            
            // Clean and validate date
            const cleanDate = date.trim();
            
            // Validate date format (should be YYYY-MM-DD)
            if (!/^\d{4}-\d{2}-\d{2}$/.test(cleanDate)) {
              console.error(`Invalid date format on line ${i}:`, cleanDate);
              alert(`Error on line ${i}: Date must be in YYYY-MM-DD format. Found: "${cleanDate}"`);
              return;
            }
            
            const entry = {
              id: Date.now() + i,
              date: cleanDate,
              show: show.trim(),
              positionType: positionType.trim() || 'Rigging LX',
              startTime: startTime.trim(),
              endTime: endTime.trim(),
              notes: notes.trim(),
              grossPay: grossPay.trim() ? parseFloat(grossPay) : null,
              netPay: netPay.trim() ? parseFloat(netPay) : null,
              hours: parseFloat(hours),
              minPayType: minPayType ? minPayType.trim() : ''
            };
            
            console.log('Created entry:', entry);
            newEntries.push(entry);
          }
          
          console.log('Total entries parsed:', newEntries.length);
          
          if (newEntries.length > 0) {
            // Store backup before importing
            const backup = {
              timestamp: new Date().toISOString(),
              entries: [...entries]
            };
            localStorage.setItem('payroll-backup-before-import', JSON.stringify(backup));
            
            if (confirm(`Import ${newEntries.length} entries? This will replace all current data.\n\nA backup of your current data will be saved.`)) {
              entries = newEntries;
              saveData();
              renderAll();
              alert('Data imported successfully! Previous data backed up.');
            }
          } else {
            alert('No valid entries found in CSV file. Please check the file format.');
          }
        } catch (error) {
          console.error('Error importing CSV:', error);
          alert('Error importing CSV file: ' + error.message);
        }
      };
      reader.readAsText(file);
      
      // Reset input
      event.target.value = '';
    }
    
    // Get unique show names for autocomplete
    function getShowNames() {
      const shows = [...new Set(entries.map(e => e.show).filter(s => s))];
      return shows.sort();
    }
    
    // Setup autocomplete for show name
    function setupShowAutocomplete() {
      const input = document.getElementById('show');
      const shows = getShowNames();
      
      // Remove existing datalist if any
      const existingDatalist = document.getElementById('showList');
      if (existingDatalist) {
        existingDatalist.remove();
      }
      
      // Create new datalist
      const datalist = document.createElement('datalist');
      datalist.id = 'showList';
      shows.forEach(show => {
        const option = document.createElement('option');
        option.value = show;
        datalist.appendChild(option);
      });
      
      input.setAttribute('list', 'showList');
      document.body.appendChild(datalist);
    }
    
    // Calculate hours from time strings
    function calculateHours(startTime, endTime) {
      const [startH, startM] = startTime.split(':').map(Number);
      const [endH, endM] = endTime.split(':').map(Number);
      
      let hours = endH - startH;
      let minutes = endM - startM;
      
      if (minutes < 0) {
        hours -= 1;
        minutes += 60;
      }
      
      return hours + (minutes / 60);
    }
    
    // Get week start (Sunday) for a date
    function getWeekStart(input) {
      if (!input) {
        console.error('Invalid date in getWeekStart:', input);
        return new Date();
      }
      
      let d;
      if (input instanceof Date) {
        // Already a Date object
        d = new Date(input);
      } else if (typeof input === 'string') {
        // Parse YYYY-MM-DD without timezone conversion
        const [year, month, day] = input.split('-').map(Number);
        d = new Date(year, month - 1, day);
      } else {
        console.error('Invalid date type in getWeekStart:', input);
        return new Date();
      }
      
      const dayOfWeek = d.getDay();
      const diff = dayOfWeek; // Sunday is 0, so diff is days since Sunday
      const weekStart = new Date(d);
      weekStart.setDate(d.getDate() - diff);
      weekStart.setHours(0, 0, 0, 0);
      return weekStart;
    }
    
    // Format date
    function formatDate(input) {
      if (!input) {
        console.error('Invalid date:', input);
        return 'Invalid Date';
      }
      
      let date;
      if (input instanceof Date) {
        // Already a Date object
        date = input;
      } else if (typeof input === 'string') {
        // Parse YYYY-MM-DD without timezone conversion
        const [year, month, day] = input.split('-').map(Number);
        date = new Date(year, month - 1, day);
      } else {
        console.error('Invalid date type:', input);
        return 'Invalid Date';
      }
      
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
    }
    
    // Format date with day of week
    function formatDateWithDay(input) {
      if (!input) {
        console.error('Invalid date:', input);
        return 'Invalid Date';
      }
      
      let date;
      if (input instanceof Date) {
        // Already a Date object
        date = input;
      } else if (typeof input === 'string') {
        // Parse YYYY-MM-DD without timezone conversion
        const [year, month, day] = input.split('-').map(Number);
        date = new Date(year, month - 1, day);
      } else {
        console.error('Invalid date type:', input);
        return 'Invalid Date';
      }
      
      const dayOfWeek = date.toLocaleDateString('en-US', { weekday: 'short' });
      const monthName = date.toLocaleDateString('en-US', { month: 'short' });
      const dayNum = date.getDate();
      const yearNum = date.getFullYear();
      const currentYear = new Date().getFullYear();
      
      // Only show year if it's different from current year
      if (yearNum !== currentYear) {
        return `${dayOfWeek} ${monthName} ${dayNum}, ${yearNum}`;
      }
      return `${dayOfWeek} ${monthName} ${dayNum}`;
    }
    
    // Add or update entry
    function addEntry() {
      const dateInput = document.getElementById('date').value;
      const show = document.getElementById('show').value;
      const positionType = getPositionType();
      const startTime = document.getElementById('startTime').value;
      const endTime = document.getElementById('endTime').value;
      const notes = document.getElementById('notes').value;
      const grossPay = parseFloat(document.getElementById('grossPay').value) || null;
      const netPay = parseFloat(document.getElementById('netPay').value) || null;
      const minPayType = document.getElementById('minPayType').value;
      
      if (!dateInput || !startTime || !endTime) {
        alert('Please fill in required fields: Date, Start Time, End Time');
        return;
      }
      
      // Store date in YYYY-MM-DD format (no timezone conversion)
      const date = dateInput;
      
      const hours = calculateHours(startTime, endTime);
      
      // Save position default if checkbox is checked
      savePositionDefault();
      
      // Add custom position if "Other" was used
      if (document.getElementById('positionType').value === 'Other' && positionType !== 'Other') {
        addCustomPosition(positionType);
      }
      
      if (editingId) {
        // Update existing entry
        const index = entries.findIndex(e => e.id === editingId);
        if (index !== -1) {
          entries[index] = {
            id: editingId,
            date,
            show,
            positionType,
            startTime,
            endTime,
            notes,
            grossPay,
            netPay,
            hours,
            minPayType
          };
        }
        editingId = null;
        document.querySelector('.form-title').textContent = 'New Entry';
        document.querySelector('button[onclick="addEntry()"]').textContent = 'Add Entry';
      } else {
        // Add new entry
        const entry = {
          id: Date.now(),
          date,
          show,
          positionType,
          startTime,
          endTime,
          notes,
          grossPay,
          netPay,
          hours,
          minPayType
        };
        entries.push(entry);
      }
      
      entries.sort((a, b) => new Date(a.date + 'T00:00:00') - new Date(b.date + 'T00:00:00'));
      
      saveData();
      renderAll();
      clearForm();
    }
    
    // Clear form
    function clearForm() {
      setTodayDate();
      document.getElementById('show').value = '';
      document.getElementById('positionType').value = 'Rigging LX';
      document.getElementById('positionTypeOther').value = '';
      document.getElementById('positionTypeOther').style.display = 'none';
      document.getElementById('startTime').value = '07:00';
      document.getElementById('endTime').value = '13:00';
      document.getElementById('notes').value = '';
      document.getElementById('grossPay').value = '';
      document.getElementById('netPay').value = '';
      document.getElementById('minPayType').value = '';
      document.getElementById('setAsDefault').checked = false;
      editingId = null;
      document.querySelector('.form-title').textContent = 'New Entry';
      document.querySelector('button[onclick="addEntry()"]').textContent = 'Add Entry';
      document.getElementById('cancelBtn').style.display = 'none';
    }
    
    // Edit entry
    function editEntry(id) {
      const entry = entries.find(e => e.id === id);
      if (!entry) return;
      
      document.getElementById('date').value = entry.date;
      document.getElementById('show').value = entry.show || '';
      
      // Set position type
      const positionType = entry.positionType || 'Rigging LX';
      const positionSelect = document.getElementById('positionType');
      const positionOther = document.getElementById('positionTypeOther');
      
      // Check if it's a standard position or custom
      const isStandardPosition = Array.from(positionSelect.options).some(opt => opt.value === positionType);
      
      if (isStandardPosition) {
        positionSelect.value = positionType;
        positionOther.style.display = 'none';
      } else {
        // It's a custom position
        positionSelect.value = 'Other';
        positionOther.value = positionType;
        positionOther.style.display = 'block';
      }
      
      document.getElementById('startTime').value = entry.startTime;
      document.getElementById('endTime').value = entry.endTime;
      document.getElementById('notes').value = entry.notes || '';
      document.getElementById('grossPay').value = entry.grossPay || '';
      document.getElementById('netPay').value = entry.netPay || '';
      document.getElementById('minPayType').value = entry.minPayType || '';
      
      editingId = id;
      document.querySelector('.form-title').textContent = 'Edit Entry';
      document.querySelector('button[onclick="addEntry()"]').textContent = 'Update Entry';
      document.getElementById('cancelBtn').style.display = 'block';
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Delete entry
    function deleteEntry(id) {
      if (confirm('Delete this entry?')) {
        entries = entries.filter(e => e.id !== id);
        saveData();
        renderAll();
      }
    }
    
    // Calculate grouped entries (multi-day shows)
    function getEntryGroups() {
      const groups = [];
      let currentGroup = [];
      
      for (let i = 0; i < entries.length; i++) {
        const entry = entries[i];
        const prevEntry = i > 0 ? entries[i - 1] : null;
        
        // Group if same show name AND in the same week
        const shouldGroup = prevEntry && 
          entry.show && 
          prevEntry.show === entry.show &&
          isSameWeek(prevEntry.date, entry.date);
        
        if (shouldGroup && currentGroup.length > 0) {
          currentGroup.push(entry);
        } else {
          if (currentGroup.length > 0) {
            groups.push(currentGroup);
          }
          currentGroup = [entry];
        }
      }
      
      if (currentGroup.length > 0) {
        groups.push(currentGroup);
      }
      
      return groups;
    }
    
    // Check if two dates are in the same week (Sunday-Saturday)
    function isSameWeek(date1, date2) {
      const week1 = getWeekStart(date1);
      const week2 = getWeekStart(date2);
      return week1.getTime() === week2.getTime();
    }
    
    // Calculate weekly summary
    function getWeeklySummary() {
      const weeks = {};
      const groups = getEntryGroups();
      
      groups.forEach(group => {
        // Find the entry with pay (if any)
        const entryWithPay = group.find(e => e.grossPay !== null && e.netPay !== null);
        const totalHours = group.reduce((sum, e) => sum + e.hours, 0);
        
        // Use the first entry's date to determine the week
        const weekStart = getWeekStart(group[0].date);
        const weekKey = weekStart.toISOString();
        
        if (!weeks[weekKey]) {
          weeks[weekKey] = {
            weekStart,
            grossPay: 0,
            netPay: 0,
            hours: 0,
            entries: 0
          };
        }
        
        if (entryWithPay) {
          weeks[weekKey].grossPay += entryWithPay.grossPay;
          weeks[weekKey].netPay += entryWithPay.netPay;
        }
        
        weeks[weekKey].hours += totalHours;
        weeks[weekKey].entries += group.length;
      });
      
      return Object.values(weeks).sort((a, b) => b.weekStart - a.weekStart);
    }
    
    // Get week number of the year
    function getWeekNumber(input) {
      if (!input) {
        console.error('Invalid date in getWeekNumber:', input);
        return 1;
      }
      
      let d;
      if (input instanceof Date) {
        // Already a Date object
        d = new Date(input);
      } else if (typeof input === 'string') {
        // Parse YYYY-MM-DD without timezone conversion
        const [year, month, day] = input.split('-').map(Number);
        d = new Date(year, month - 1, day);
      } else {
        console.error('Invalid date type in getWeekNumber:', input);
        return 1;
      }
      
      d.setHours(0, 0, 0, 0);
      d.setDate(d.getDate() + 4 - (d.getDay() || 7));
      const yearStart = new Date(d.getFullYear(), 0, 1);
      const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
      return weekNo;
    }
    
    // Render global stats
    function renderGlobalStats() {
      const container = document.getElementById('globalStats');
      
      if (entries.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      const groups = getEntryGroups();
      
      // Calculate totals
      let totalHours = 0;
      let paidHours = 0;
      let totalGrossPay = 0;
      let totalNetPay = 0;
      let paidShows = 0;
      let paidDays = 0;
      let pendingShows = 0;
      let pendingDays = 0;
      let pendingHours = 0;
      let totalStandardRateHours = 0;
      let daysWithoutMinPay = 0;
      
      const dates = entries.map(e => new Date(e.date));
      const firstDate = new Date(Math.min(...dates));
      const lastDate = new Date(Math.max(...dates));
      
      groups.forEach(group => {
        const groupHours = group.reduce((sum, e) => sum + e.hours, 0);
        totalHours += groupHours;
        
        // Calculate standard rate hours for this group and count days without min pay
        group.forEach(entry => {
          if (entry.minPayType) {
            const breakdown = getPayHoursBreakdown(entry);
            totalStandardRateHours += breakdown.standardRate;
          } else {
            daysWithoutMinPay++;
          }
        });
        
        const entryWithPay = group.find(e => e.grossPay !== null && e.netPay !== null);
        if (entryWithPay) {
          totalGrossPay += entryWithPay.grossPay;
          totalNetPay += entryWithPay.netPay;
          paidShows++;
          paidDays += group.length;
          paidHours += groupHours; // Only count hours from paid shows
        } else {
          pendingShows++;
          pendingDays += group.length;
          pendingHours += groupHours;
        }
      });
      
      // Calculate hourly rate using ONLY paid hours
      const avgGrossHourly = paidHours > 0 ? (totalGrossPay / paidHours).toFixed(2) : '0.00';
      const avgNetHourly = paidHours > 0 ? (totalNetPay / paidHours).toFixed(2) : '0.00';
      
      // V2: Create field data mapping
      const allTimeFieldData = {
        totalHours: { label: 'Total Hours', value: totalHours.toFixed(2), class: 'hours' },
        totalDays: { label: 'Total Days', value: entries.length, class: '' },
        totalStandard: { 
          label: 'Total Standard (1x)', 
          value: totalStandardRateHours > 0 ? `${totalStandardRateHours.toFixed(2)} hrs${daysWithoutMinPay > 0 ? ` (${daysWithoutMinPay} days without min pay)` : ''}` : null, 
          class: '' 
        },
        totalGrossPay: { label: 'Total Gross Pay', value: `$${totalGrossPay.toFixed(2)}`, class: 'money' },
        totalNetPay: { label: 'Total Net Pay', value: `$${totalNetPay.toFixed(2)}`, class: 'money' },
        avgGrossHr: { label: 'Avg Gross/Hr', value: `$${avgGrossHourly}`, class: 'rate' },
        avgNetHr: { label: 'Avg Net/Hr', value: `$${avgNetHourly}`, class: 'rate' },
        pendingShows: { label: 'Pay Pending Shows', value: pendingShows > 0 ? pendingShows : null, class: '', style: 'color: var(--warning);' },
        pendingDays: { label: 'Pay Pending Days', value: pendingShows > 0 ? pendingDays : null, class: '', style: 'color: var(--warning);' },
        pendingHours: { label: 'Pay Pending Hours', value: pendingShows > 0 ? pendingHours.toFixed(2) : null, class: '', style: 'color: var(--warning);' }
      };
      
      // V2: Render fields based on customization
      const fieldsToRender = getAllTimeFieldOrder();
      let fieldsHtml = '';
      
      fieldsToRender.forEach(fieldId => {
        const field = allTimeFieldData[fieldId];
        if (field && field.value !== null) {
          fieldsHtml += `
            <div class="summary-item">
              <div class="summary-label">${field.label}</div>
              <div class="summary-value ${field.class}" ${field.style ? `style="${field.style}"` : ''}>${field.value}</div>
            </div>
          `;
        }
      });
      
      container.innerHTML = `
        <div class="weekly-summary" style="margin-bottom: 24px;">
          <div style="cursor: pointer;" onclick="toggleAllTimeStats()">
            <div class="week-header">
              <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                <div>
                  <div class="week-title">All Time Stats</div>
                  <div class="week-range">${formatDate(firstDate)} - ${formatDate(lastDate)}</div>
                </div>
                <div id="arrow-alltimestats" style="font-size: 20px; color: var(--accent);">‚ñº</div>
              </div>
            </div>
          </div>
          <div id="allTimeStatsDetails" style="display: none;">
            <div class="summary-grid" style="margin-top: 12px;">
              ${fieldsHtml}
            </div>
          </div>
        </div>
      `;
    }
    
    // Calculate payable hours based on minimum pay type
    function getPayableHours(entry) {
      if (!entry.minPayType) return entry.hours;
      
      let minHours = 0;
      switch(entry.minPayType) {
        case '8hr':
          minHours = 8;
          break;
        case '10hr':
          minHours = 10;
          break;
        case '12hr':
          minHours = 12;
          break;
        default:
          return entry.hours;
      }
      
      return Math.max(entry.hours, minHours);
    }
    
    // Calculate pay hours breakdown by rate (1x, 1.5x, 2x, 3x) based on union rules
    function getPayHoursBreakdown(entry) {
      if (!entry.minPayType) {
        return {
          standardRate: entry.hours,
          timeAndHalf: 0,
          doubleTime: 0,
          tripleTime: 0,
          totalPayable: entry.hours
        };
      }
      
      const actualHours = entry.hours;
      let minHours = 0;
      
      switch(entry.minPayType) {
        case '8hr':
          minHours = 8;
          break;
        case '10hr':
          minHours = 10;
          break;
        case '12hr':
          minHours = 12;
          break;
      }
      
      const payableHours = Math.max(actualHours, minHours);
      
      let standardRate = 0;    // 1x
      let timeAndHalf = 0;     // 1.5x (hours 9-12)
      let doubleTime = 0;      // 2x (hours 13-15)
      let tripleTime = 0;      // 3x (hours 16+)
      
      // If worked less than minimum, pay minimum at standard rate
      if (actualHours <= minHours) {
        if (minHours <= 8) {
          standardRate = minHours;
        } else if (minHours <= 12) {
          // 10hr or 12hr minimum where we didn't work that long
          standardRate = 8;
          timeAndHalf = minHours - 8;
        }
      } else {
        // Worked more than minimum - pay based on actual hours with overtime
        if (actualHours <= 8) {
          standardRate = actualHours;
        } else if (actualHours <= 12) {
          standardRate = 8;
          timeAndHalf = actualHours - 8;
        } else if (actualHours <= 15) {
          standardRate = 8;
          timeAndHalf = 4;  // hours 9-12
          doubleTime = actualHours - 12;
        } else {
          standardRate = 8;
          timeAndHalf = 4;  // hours 9-12
          doubleTime = 3;   // hours 13-15
          tripleTime = actualHours - 15;
        }
      }
      
      return {
        standardRate,
        timeAndHalf,
        doubleTime,
        tripleTime,
        totalPayable: payableHours
      };
    }
    
    // Render weekly summary
    function renderWeeklySummary() {
      const summary = getWeeklySummary();
      const container = document.getElementById('weeklySummary');
      
      if (summary.length === 0) {
        container.innerHTML = '';
        return;
      }
      
      let html = '';
      
      // Check if current week has entries
      const today = new Date();
      const currentWeekStart = getWeekStart(today);
      const currentWeek = summary.find(week => 
        week.weekStart.getTime() === currentWeekStart.getTime()
      );
      
      // Show current week if it exists
      if (currentWeek) {
        const weekEnd = new Date(currentWeek.weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        
        // Get all entries for this week
        const groups = getEntryGroups();
        const currentWeekGroups = groups.filter(group => {
          const groupWeekStart = getWeekStart(group[0].date);
          return groupWeekStart.getTime() === currentWeekStart.getTime();
        });
        
        // Flatten to get all entries
        const currentWeekEntries = currentWeekGroups.flat();
        
        // Check if ALL entries have min pay type
        const allHaveMinPay = currentWeekEntries.every(entry => entry.minPayType);
        
        let payableHours = 0;
        let standardRate = 0;
        let timeAndHalf = 0;
        let doubleTime = 0;
        let tripleTime = 0;
        
        if (allHaveMinPay) {
          currentWeekEntries.forEach(entry => {
            const breakdown = getPayHoursBreakdown(entry);
            payableHours += breakdown.totalPayable;
            standardRate += breakdown.standardRate;
            timeAndHalf += breakdown.timeAndHalf;
            doubleTime += breakdown.doubleTime;
            tripleTime += breakdown.tripleTime;
          });
        }
        
        const numShows = currentWeekGroups.length;
        
        const avgGrossHourly = currentWeek.grossPay > 0 ? (currentWeek.grossPay / currentWeek.hours).toFixed(2) : '0.00';
        const avgNetHourly = currentWeek.netPay > 0 ? (currentWeek.netPay / currentWeek.hours).toFixed(2) : '0.00';
        
        // V2: Create field data mapping
        const thisWeekFieldData = {
          hoursWorked: { label: 'Hours Worked', value: currentWeek.hours.toFixed(2), class: 'hours' },
          standardPayable: { label: 'Standard Payable Hrs', value: allHaveMinPay ? payableHours.toFixed(2) : 'N/A', class: 'hours' },
          daysWorked: { label: 'Days Worked', value: currentWeek.entries, class: '' },
          numShows: { label: 'Number of Shows', value: numShows, class: '' },
          standard1x: { label: 'Standard (1x)', value: allHaveMinPay ? standardRate.toFixed(2) : null, class: '' },
          ot15x: { label: 'OT (1.5x)', value: allHaveMinPay ? timeAndHalf.toFixed(2) : null, class: '' },
          time2x: { label: '2x Time', value: (allHaveMinPay && (doubleTime > 0 || tripleTime > 0)) ? doubleTime.toFixed(2) : null, class: '' },
          time3x: { label: '3x Time', value: (allHaveMinPay && (doubleTime > 0 || tripleTime > 0)) ? tripleTime.toFixed(2) : null, class: '' },
          avgGrossHr: { label: 'Avg Gross/Hr', value: currentWeek.grossPay > 0 ? `$${avgGrossHourly}` : null, class: 'rate' },
          avgNetHr: { label: 'Avg Net/Hr', value: currentWeek.netPay > 0 ? `$${avgNetHourly}` : null, class: 'rate' }
        };
        
        // V2: Render fields based on customization
        const fieldsToRender = getThisWeekFieldOrder();
        let fieldsHtml = '';
        
        fieldsToRender.forEach(fieldId => {
          const field = thisWeekFieldData[fieldId];
          if (field && field.value !== null) {
            fieldsHtml += `
              <div class="summary-item">
                <div class="summary-label">${field.label}</div>
                <div class="summary-value ${field.class}">${field.value}</div>
              </div>
            `;
          }
        });
        
        html += `
          <div class="weekly-summary">
            <div style="cursor: pointer;" onclick="toggleThisWeek()">
              <div class="week-header">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                  <div>
                    <div class="week-title">This Week</div>
                    <div class="week-range">${formatDate(currentWeek.weekStart)} - ${formatDate(weekEnd)}</div>
                  </div>
                  <div id="arrow-thisweek" style="font-size: 20px; color: var(--accent);">‚ñº</div>
                </div>
              </div>
            </div>
            <div id="thisWeekDetails" style="display: none;">
              <div class="summary-grid" style="margin-top: 12px;">
                ${fieldsHtml}
              </div>
            </div>
          </div>
        `;
      }
      
      container.innerHTML = html;
    }
    
    // Toggle backup menu
    function toggleBackupMenu() {
      const menu = document.getElementById('backupMenu');
      const isOpening = menu.style.display === 'none';
      menu.style.display = isOpening ? 'block' : 'none';
      
      if (isOpening) {
        updateCSVTrackingInfo();
      }
    }
    
    // Update CSV tracking info in menu
    function updateCSVTrackingInfo() {
      const container = document.getElementById('csvTrackingInfo');
      let html = '';
      
      // Get tracking data
      const lastLoad = localStorage.getItem('payroll-last-load');
      const lastSave = localStorage.getItem('payroll-last-save');
      
      if (lastLoad) {
        try {
          const loadInfo = JSON.parse(lastLoad);
          const loadDate = new Date(loadInfo.timestamp);
          const timeAgo = getTimeAgo(loadDate);
          
          // Calculate changes since load
          const loadedEntries = JSON.parse(loadInfo.entries);
          const changes = calculateChangesSinceLoad(loadedEntries);
          
          html += `
            <div style="margin-bottom: 6px;">
              <strong>Last CSV Load:</strong><br>
              ${timeAgo} (${loadInfo.entryCount} entries)
            </div>
          `;
          
          if (changes.new > 0 || changes.modified > 0 || changes.deleted > 0) {
            html += `
              <div style="margin-bottom: 6px; color: var(--warning);">
                <strong>Changes since load:</strong><br>
                ${changes.new > 0 ? `+${changes.new} new ` : ''}
                ${changes.modified > 0 ? `~${changes.modified} edited ` : ''}
                ${changes.deleted > 0 ? `-${changes.deleted} deleted` : ''}
              </div>
            `;
          }
        } catch (e) {
          console.error('Error parsing load info:', e);
        }
      }
      
      if (lastSave) {
        try {
          const saveInfo = JSON.parse(lastSave);
          const saveDate = new Date(saveInfo.timestamp);
          const timeAgo = getTimeAgo(saveDate);
          
          html += `
            <div style="margin-bottom: 6px;">
              <strong>Last CSV Save:</strong><br>
              ${timeAgo} (${saveInfo.entryCount} entries)
            </div>
          `;
        } catch (e) {
          console.error('Error parsing save info:', e);
        }
      }
      
      if (!lastLoad && !lastSave) {
        html = '<div style="color: var(--text-dim);">No CSV activity yet</div>';
      }
      
      container.innerHTML = html;
    }
    
    // Calculate changes since last CSV load
    function calculateChangesSinceLoad(loadedEntries) {
      const changes = { new: 0, modified: 0, deleted: 0 };
      
      // Create maps for comparison
      const loadedMap = new Map();
      loadedEntries.forEach(e => {
        loadedMap.set(e.date + '-' + e.show, JSON.stringify(e));
      });
      
      const currentMap = new Map();
      entries.forEach(e => {
        currentMap.set(e.date + '-' + e.show, JSON.stringify(e));
      });
      
      // Check for new and modified
      currentMap.forEach((value, key) => {
        if (!loadedMap.has(key)) {
          changes.new++;
        } else if (loadedMap.get(key) !== value) {
          changes.modified++;
        }
      });
      
      // Check for deleted
      loadedMap.forEach((value, key) => {
        if (!currentMap.has(key)) {
          changes.deleted++;
        }
      });
      
      return changes;
    }
    
    // Get time ago string
    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      
      if (seconds < 60) return 'Just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      if (days < 7) return `${days}d ago`;
      
      return date.toLocaleDateString();
    }
    
    // Expand all weeks
    function expandAllWeeks() {
      document.querySelectorAll('[id^="week-content-"]').forEach(el => {
        el.style.display = 'block';
      });
      document.querySelectorAll('[id^="week-arrow-"]').forEach(el => {
        el.textContent = '‚ñ≤';
      });
    }
    
    // Collapse all weeks
    function collapseAllWeeks() {
      document.querySelectorAll('[id^="week-content-"]').forEach(el => {
        el.style.display = 'none';
      });
      document.querySelectorAll('[id^="week-arrow-"]').forEach(el => {
        el.textContent = '‚ñº';
      });
    }
    
    // Toggle week visibility
    function toggleWeek(weekId) {
      const element = document.getElementById('week-content-' + weekId);
      const arrow = document.getElementById('week-arrow-' + weekId);
      
      if (element.style.display === 'none') {
        element.style.display = 'block';
        arrow.textContent = '‚ñ≤';
      } else {
        element.style.display = 'none';
        arrow.textContent = '‚ñº';
      }
    }
    
    // Close backup menu when clicking outside
    document.addEventListener('click', function(event) {
      const menu = document.getElementById('backupMenu');
      const button = event.target.closest('button');
      
      if (menu && menu.style.display === 'block' && !menu.contains(event.target) && (!button || button.textContent.indexOf('Data') === -1)) {
        menu.style.display = 'none';
      }
    });
    
    // Toggle this week visibility
    function toggleThisWeek() {
      const element = document.getElementById('thisWeekDetails');
      const arrow = document.getElementById('arrow-thisweek');
      
      if (element.style.display === 'none') {
        element.style.display = 'block';
        arrow.textContent = '‚ñ≤';
      } else {
        element.style.display = 'none';
        arrow.textContent = '‚ñº';
      }
    }
    
    // Toggle all time stats visibility
    function toggleAllTimeStats() {
      const element = document.getElementById('allTimeStatsDetails');
      const arrow = document.getElementById('arrow-alltimestats');
      
      if (element.style.display === 'none') {
        element.style.display = 'block';
        arrow.textContent = '‚ñ≤';
      } else {
        element.style.display = 'none';
        arrow.textContent = '‚ñº';
      }
    }
    
    // Render entries list grouped by week
    function renderEntries() {
      const container = document.getElementById('entriesList');
      const groups = getEntryGroups();
      
      if (groups.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìä</div>
            <div>No entries yet. Add your first shift above!</div>
          </div>
        `;
        return;
      }
      
      // Group entries by week
      const weekGroups = {};
      
      groups.forEach(group => {
        const weekStart = getWeekStart(group[0].date);
        const weekKey = weekStart.toISOString();
        
        if (!weekGroups[weekKey]) {
          weekGroups[weekKey] = {
            weekStart,
            groups: []
          };
        }
        
        weekGroups[weekKey].groups.push(group);
      });
      
      // Sort weeks in reverse chronological order
      const sortedWeeks = Object.values(weekGroups).sort((a, b) => b.weekStart - a.weekStart);
      
      let html = '';
      
      sortedWeeks.forEach(week => {
        const weekEnd = new Date(week.weekStart);
        weekEnd.setDate(weekEnd.getDate() + 6);
        const weekNumber = getWeekNumber(week.weekStart);
        
        // Calculate total hours and pay for the week
        let weekHours = 0;
        let weekPaidHours = 0;
        let weekGrossPay = 0;
        let weekNetPay = 0;
        let totalDays = 0;
        let pendingCheques = 0;
        
        week.groups.forEach(group => {
          const groupHours = group.reduce((gsum, e) => gsum + e.hours, 0);
          weekHours += groupHours;
          totalDays += group.length;
          const entryWithPay = group.find(e => e.grossPay !== null && e.netPay !== null);
          if (entryWithPay) {
            weekGrossPay += entryWithPay.grossPay;
            weekNetPay += entryWithPay.netPay;
            weekPaidHours += groupHours;
          } else {
            pendingCheques++;
          }
        });
        
        const numShows = week.groups.length;
        const weekId = week.weekStart.getTime();
        
        // Calculate weekly hourly rates (only for paid hours)
        const weekGrossHourly = weekPaidHours > 0 ? (weekGrossPay / weekPaidHours).toFixed(2) : '0.00';
        const weekNetHourly = weekPaidHours > 0 ? (weekNetPay / weekPaidHours).toFixed(2) : '0.00';
        
        // Create days/shows description
        let daysShowsText = '';
        if (totalDays === numShows) {
          daysShowsText = `${totalDays} day${totalDays > 1 ? 's' : ''} / ${numShows} show${numShows > 1 ? 's' : ''}`;
        } else {
          daysShowsText = `${totalDays} days on ${numShows} show${numShows > 1 ? 's' : ''}`;
        }
        
        // V2: Create field data mapping for week headers
        const weekHeaderFieldData = {
          weekNumber: { value: `Week ${weekNumber} of 52` },
          dateRange: { value: `${formatDate(week.weekStart)} - ${formatDate(weekEnd)}` },
          daysShows: { value: daysShowsText },
          totalHours: { value: `${weekHours.toFixed(2)} hrs` },
          grossPay: { value: weekGrossPay > 0 ? `Gross: $${weekGrossPay.toFixed(2)} ($${weekGrossHourly}/hr)` : null },
          netPay: { value: weekGrossPay > 0 ? `Net: $${weekNetPay.toFixed(2)} ($${weekNetHourly}/hr)` : null },
          pendingCheques: { value: pendingCheques > 0 ? `${pendingCheques} cheque${pendingCheques > 1 ? 's' : ''} pending` : null }
        };
        
        // V2: Render fields based on customization
        const headerFieldsToRender = getWeekHeaderFieldOrder();
        let headerLine1 = [];
        let headerLine2 = [];
        let headerLine3 = [];
        
        headerFieldsToRender.forEach(fieldId => {
          const field = weekHeaderFieldData[fieldId];
          if (field && field.value !== null) {
            // Organize fields into lines
            if (fieldId === 'weekNumber' || fieldId === 'dateRange') {
              headerLine1.push(field.value);
            } else if (fieldId === 'grossPay' || fieldId === 'netPay') {
              headerLine3.push(field.value);
            } else {
              headerLine2.push(field.value);
            }
          }
        });
        
        html += `
          <div style="margin-bottom: 24px;">
            <div onclick="toggleWeek('${weekId}')" style="cursor: pointer; font-size: 12px; font-weight: 700; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; padding: 12px; background: var(--surface); border: 1px solid var(--border); border-radius: 8px;">
              <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div style="flex: 1;">
                  ${headerLine1.length > 0 ? `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                      <span>${headerLine1.join(' ‚Ä¢ ')}</span>
                      <span id="week-arrow-${weekId}" style="font-size: 16px; color: var(--accent); margin-left: 12px;">‚ñº</span>
                    </div>
                  ` : `
                    <span id="week-arrow-${weekId}" style="font-size: 16px; color: var(--accent); float: right;">‚ñº</span>
                  `}
                  ${headerLine2.length > 0 ? `
                    <div style="font-size: 10px; color: var(--text); margin-top: 4px; font-weight: normal;">
                      ${headerLine2.join(' ‚Ä¢ ')}
                    </div>
                  ` : ''}
                  ${headerLine3.length > 0 ? `
                    <div style="display: flex; gap: 16px; font-size: 10px; margin-top: 4px; font-weight: normal;">
                      ${headerLine3.map(text => `<span style="color: var(--success);">${text}</span>`).join('')}
                    </div>
                  ` : ''}
                </div>
              </div>
            </div>
            
            <div id="week-content-${weekId}" style="display: none;">
        `;
        
        week.groups.forEach((group, groupIndex) => {
          const entryWithPay = group.find(e => e.grossPay !== null && e.netPay !== null);
          const totalHours = group.reduce((sum, e) => sum + e.hours, 0);
          const isMultiDay = group.length > 1;
          const showName = group[0].show || '(continued)';
          const groupId = `group-${week.weekStart.getTime()}-${groupIndex}`;
          
          let grossHourly = '';
          let netHourly = '';
          
          if (entryWithPay && totalHours > 0) {
            grossHourly = (entryWithPay.grossPay / totalHours).toFixed(2);
            netHourly = (entryWithPay.netPay / totalHours).toFixed(2);
          }
          
          // Always make multi-day shows collapsible
          if (isMultiDay) {
            // Collapsed view for multi-day shows
            html += `
              <div class="entry-card grouped" style="cursor: pointer;">
                <div onclick="toggleGroup('${groupId}')" style="display: flex; justify-content: space-between; align-items: flex-start;">
                  <div style="flex: 1;">
                    <div class="entry-date">${formatDateWithDay(group[0].date)} - ${formatDateWithDay(group[group.length - 1].date)}</div>
                    <div class="entry-show">${showName} <span style="font-size: 11px; color: var(--text-dim);">(${group.length} days)</span></div>
                    <div class="entry-time">${totalHours.toFixed(2)} hours total</div>
                  </div>
                  <div id="arrow-${groupId}" style="font-size: 20px; color: var(--accent); user-select: none;">‚ñº</div>
                </div>
                
                ${entryWithPay ? `
                  <div class="entry-details" style="margin-top: 12px;">
                    <div class="detail-item">
                      <div class="detail-label">Gross Pay</div>
                      <div class="detail-value money">$${entryWithPay.grossPay.toFixed(2)}</div>
                    </div>
                    <div class="detail-item">
                      <div class="detail-label">Net Pay</div>
                      <div class="detail-value money">$${entryWithPay.netPay.toFixed(2)}</div>
                    </div>
                    <div class="detail-item">
                      <div class="detail-label">Gross/Hr</div>
                      <div class="detail-value rate">$${grossHourly}</div>
                    </div>
                    <div class="detail-item">
                      <div class="detail-label">Net/Hr</div>
                      <div class="detail-value rate">$${netHourly}</div>
                    </div>
                  </div>
                ` : ''}
              
                <!-- Expanded details -->
                <div id="${groupId}" style="display: none; margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border);">
            `;
            
            // Individual days within the group
            group.forEach((entry) => {
              const showPay = entry.id === entryWithPay?.id;
              
              html += `
                <div style="background: var(--bg); border-radius: 6px; padding: 12px; margin-bottom: 8px;">
                  <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                    <div>
                      <div class="entry-date" style="font-size: 12px;">${formatDateWithDay(entry.date)}</div>
                      ${entry.positionType ? `<div style="font-size: 11px; color: var(--text-dim);">üìã ${entry.positionType}</div>` : ''}
                      <div class="entry-time">${entry.startTime} - ${entry.endTime} (${entry.hours.toFixed(2)} hrs)</div>
                      ${entry.notes ? `<div class="entry-time">${entry.notes}</div>` : ''}
                    </div>
                  </div>
                  
                  ${showPay ? `
                    <div style="font-size: 11px; color: var(--success); margin-top: 8px; padding: 6px; background: var(--surface); border-radius: 4px;">
                      ‚úì Pay entered: $${entry.grossPay.toFixed(2)} gross / $${entry.netPay.toFixed(2)} net
                    </div>
                  ` : ''}
                  
                  <div style="display: flex; gap: 8px; margin-top: 8px; justify-content: flex-end;">
                    <button style="background: transparent; border: 1px solid var(--border); color: var(--text-dim); padding: 6px 12px; font-size: 16px; border-radius: 4px;" onclick="event.stopPropagation(); editEntry(${entry.id})" title="Edit">‚úèÔ∏è</button>
                    <button style="background: transparent; border: 1px solid var(--border); color: var(--text-dim); padding: 6px 12px; font-size: 16px; border-radius: 4px;" onclick="event.stopPropagation(); deleteEntry(${entry.id})" title="Delete">üóëÔ∏è</button>
                  </div>
                </div>
              `;
            });
            
            html += `
                </div>
              </div>
            `;
            
          } else {
            // Single day entry
            const entry = group[0];
            const showPay = entry.id === entryWithPay?.id;
            
            html += `
              <div class="entry-card">
                <div class="entry-header">
                  <div>
                    <div class="entry-date">${formatDateWithDay(entry.date)}</div>
                    <div class="entry-show">${showName}</div>
                    ${entry.positionType ? `<div style="font-size: 12px; color: var(--text-dim); margin-bottom: 4px;">üìã ${entry.positionType}</div>` : ''}
                    <div class="entry-time">${entry.startTime} - ${entry.endTime}</div>
                    ${entry.notes ? `<div class="entry-time">${entry.notes}</div>` : ''}
                  </div>
                </div>
                
                <div class="entry-details">
                  <div class="detail-item">
                    <div class="detail-label">Hours</div>
                    <div class="detail-value">${entry.hours.toFixed(2)}</div>
                  </div>
                  ${showPay ? `
                    <div class="detail-item">
                      <div class="detail-label">Gross Pay</div>
                      <div class="detail-value money">$${entry.grossPay.toFixed(2)}</div>
                    </div>
                    <div class="detail-item">
                      <div class="detail-label">Net Pay</div>
                      <div class="detail-value money">$${entry.netPay.toFixed(2)}</div>
                    </div>
                    <div class="detail-item">
                      <div class="detail-label">Gross/Hr</div>
                      <div class="detail-value rate">$${grossHourly}</div>
                    </div>
                    <div class="detail-item">
                      <div class="detail-label">Net/Hr</div>
                      <div class="detail-value rate">$${netHourly}</div>
                    </div>
                  ` : `
                    <div class="detail-item">
                      <div class="detail-label">Pay Status</div>
                      <div class="detail-value" style="color: var(--text-dim)">Pending</div>
                    </div>
                  `}
                </div>
                
                <div class="entry-actions" style="display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px;">
                  <button style="background: transparent; border: 1px solid var(--border); color: var(--text-dim); padding: 6px 12px; font-size: 16px; border-radius: 4px;" onclick="editEntry(${entry.id})" title="Edit">‚úèÔ∏è</button>
                  <button style="background: transparent; border: 1px solid var(--border); color: var(--text-dim); padding: 6px 12px; font-size: 16px; border-radius: 4px;" onclick="deleteEntry(${entry.id})" title="Delete">üóëÔ∏è</button>
                </div>
              </div>
            `;
          }
        });
        
        html += `
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    // Toggle group visibility
    function toggleGroup(groupId) {
      event.stopPropagation();
      const element = document.getElementById(groupId);
      const arrow = document.getElementById('arrow-' + groupId);
      
      if (element.style.display === 'none') {
        element.style.display = 'block';
        arrow.textContent = '‚ñ≤';
      } else {
        element.style.display = 'none';
        arrow.textContent = '‚ñº';
      }
    }
    
    // Render all
    function renderAll() {
      renderWeeklySummary();
      renderGlobalStats();
      renderEntries();
      setupShowAutocomplete();
    }
    
    // Set today's date and default start time
    document.getElementById('date').valueAsDate = new Date();
    document.getElementById('startTime').value = '07:00';
    document.getElementById('endTime').value = '13:00';
    
    // Load data when page loads
    loadData();
  </script>
</body>
</html>
